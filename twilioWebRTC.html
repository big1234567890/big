<!DOCTYPE html>
<html lang="en">
<head>
    <title>Twilio WebRTC + SIP & Phone</title>
    <script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
</head>
<body>
    <h2>Twilio WebRTC + SIP & Phone</h2>
    <p id="status">üîÑ Initializing...</p>

    <button id="startButton">Start Calling</button>
    <input type="text" id="callTo" placeholder="Enter Phone Number" />
    <button onclick="makeCall()">Call</button>
    <button onclick="hangUpCall()">Hang Up</button>
    <button id="answerButton" style="display:none;">Answer</button>
    <button id="rejectButton" style="display:none;">Reject</button>

    <script>
        let device;
        let incomingConnection = null;

        async function fetchToken() {
            try {
                const response = await fetch('https://mahogany-dinosaur-3523.twil.io/token');
                if (!response.ok) throw new Error("Failed to fetch token");
                const data = await response.json();
                console.log("‚úÖ Extracted Token:", data.token);
                return data.token;
            } catch (error) {
                console.error("‚ùå Error Fetching Token:", error);
                document.getElementById("status").innerText = "‚ùå Token Fetch Failed!";
                return null;
            }
        }

        async function setupTwilioDevice() {
            const token = await fetchToken();
            if (!token) return;

            device = new Twilio.Device(token, {
                codecPreferences: ["opus", "pcmu"],
                enableRingingState: true
            });

            device.on("ready", () => {
                console.log("‚úÖ Twilio Device Ready");
                document.getElementById("status").innerText = "‚úÖ Ready to make/receive calls";
            });

            device.on("incoming", (connection) => {
                console.log("üìû Incoming Call...");
                document.getElementById("status").innerText = "üìû Incoming Call...";
                incomingConnection = connection;

                document.getElementById("answerButton").style.display = "inline";
                document.getElementById("rejectButton").style.display = "inline";
            });

            device.on("error", (error) => {
                console.error("‚ùå Twilio Device Error:", error.message);
                document.getElementById("status").innerText = "‚ùå Error: " + error.message;
            });
        }

        async function requestMicAndSetupDevice() {
            try {
                console.log("üîÑ Requesting microphone access...");
                await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("üé§ Microphone access granted");
                await setupTwilioDevice();
            } catch (error) {
                console.error("‚ùå Microphone access denied:", error);
                document.getElementById("status").innerText = "‚ùå Microphone access denied!";
            }
        }

        document.getElementById("startButton").addEventListener("click", async () => {
            await requestMicAndSetupDevice();
        });

        async function answerCall() {
            await requestMicAndSetupDevice(); // Ensure mic and device are set up

            if (incomingConnection) {
                console.log("‚úÖ Call Answered");
                document.getElementById("status").innerText = "‚úÖ Call in Progress...";
                incomingConnection.accept();
                document.getElementById("answerButton").style.display = "none";
                document.getElementById("rejectButton").style.display = "none";
            }
        }

        document.getElementById("answerButton").addEventListener("click", answerCall);

        function rejectCall() {
            if (incomingConnection) {
                console.log("‚ùå Call Rejected");
                document.getElementById("status").innerText = "‚úÖ Ready to receive calls";
                incomingConnection.reject();
                document.getElementById("answerButton").style.display = "none";
                document.getElementById("rejectButton").style.display = "none";
            }
        }

        document.getElementById("rejectButton").addEventListener("click", rejectCall);

        function makeCall() {
            const to = document.getElementById("callTo").value.trim();

            if (!to) {
                alert("Enter a phone number to call!");
                return;
            }

            if (!device) {
                console.error("‚ùå Twilio Device not initialized.");
                document.getElementById("status").innerText = "‚ùå Device not ready!";
                return;
            }

            let params = { To: to };

            console.log("üìû Calling:", params.To);

            const connection = device.connect(params);

            connection.on("accept", () => {
                console.log("‚úÖ Call Connected");
                document.getElementById("status").innerText = "‚úÖ Call Connected";
            });

            connection.on("disconnect", () => {
                console.log("üî¥ Call Disconnected");
                document.getElementById("status").innerText = "‚úÖ Ready to make/receive calls";
            });

            connection.on("error", (error) => {
                console.error("‚ùå Call Error:", error.message);
                document.getElementById("status").innerText = "‚ùå Call Failed!";
            });
        }

        function hangUpCall() {
            if (device) {
                device.disconnectAll();
                console.log("üî¥ Call Ended");
                document.getElementById("status").innerText = "‚úÖ Ready to make/receive calls";
            }
        }
    </script>
</body>
</html>
