<!DOCTYPE html>
<html lang="en">
<head>
    <title>Twilio WebRTC + SIP</title>
    <script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
    <script>
        let device;

        // Fetch Twilio Access Token
     async function fetchToken() {
    try {
        console.log("ğŸ”„ Fetching Twilio Token...");

        const response = await fetch("https://bigappmarket-dev.appiancloud.com/suite/webapi/generatetoken", {
            method: "GET",
            headers: { "Accept": "application/json" }
        });

        if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);

        const data = await response.json();  // âœ… Parse JSON response
        console.log("âœ… Token Received:", data);

        const token = data.token;  // âœ… Extract the correct token value

        if (!token) throw new Error("Token not found in response");

        return token;
    } catch (error) {
        console.error("âŒ Error Fetching Token:", error);
        document.getElementById("status").innerText = "âŒ Error Fetching Token: " + error.message;
        return null;
    }
}
        // Setup Twilio WebRTC Device
        async function setupTwilioDevice() {
    try {
        console.log("ğŸ”„ Fetching Twilio Token...");
        const token = await fetchToken();

        if (!token) throw new Error("âŒ No token received!");

        console.log("âœ… Extracted Token:", token);  // Debug log

        device = new Twilio.Device(token, {
            codecPreferences: ["opus", "pcmu"],
            enableRingingState: true
        });

        device.on("ready", () => {
            console.log("âœ… Twilio Device Ready");
            document.getElementById("status").innerText = "âœ… Ready to make calls";
        });

        device.on("error", (error) => {
            console.error("âŒ Twilio Device Error:", error.message);
            document.getElementById("status").innerText = "âŒ Error: " + error.message;
        });

    } catch (error) {
        console.error("âŒ Setup Error:", error);
        document.getElementById("status").innerText = "âŒ Error Initializing Device";
    }
}

       

     function makeCall() {
            const to = document.getElementById("callTo").value;
            if (!to) {
                alert("Enter a SIP address or number to call!");
                return;
            }

            const params = { To: `sip:big@bitsinglass.sip.twilio.com` };
            device.connect(params);
            console.log("ğŸ“ Calling:", params.To);
            document.getElementById("status").innerText = "ğŸ“ Calling...";
        }

        function hangUpCall() {
            if (device) {
                device.disconnectAll();
                console.log("ğŸ”´ Call Ended");
                document.getElementById("status").innerText = "âœ… Ready to make calls";
            }
        }

        window.onload = setupTwilioDevice;
    </script>
</head>
<body>
    <h2>Twilio WebRTC + SIP</h2>
    <p id="status">ğŸ”„ Initializing...</p>
    <input type="text" id="callTo" placeholder="Enter SIP Username" />
    <button onclick="makeCall()">Call</button>
    <button onclick="hangUpCall()">Hang Up</button>
    <button id="answerButton" style="display:none;">Answer</button>
    <button id="rejectButton" style="display:none;">Reject</button>
</body>
</html>
